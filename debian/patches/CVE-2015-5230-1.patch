From c849701f7be442b21db69366d00cd92b64d660cd Mon Sep 17 00:00:00 2001
From: Peter van Dijk <peter.van.dijk@netherlabs.nl>
Date: Mon, 24 Aug 2015 16:26:25 +0200
Subject: [PATCH] avoid superfluous backend recycling

---
 pdns/distributor.hh | 22 ++++++++++++++++++++--
 1 file changed, 20 insertions(+), 2 deletions(-)

diff --git a/pdns/distributor.hh b/pdns/distributor.hh
index d716869..f958ff3 100644
--- a/pdns/distributor.hh
+++ b/pdns/distributor.hh
@@ -259,7 +259,16 @@ template<class Answer, class Question, class Backend>void *MultiThreadDistributo
       AnswerData<Answer> AD;
       AD.A=a;
 
-      QD.callback(AD);
+      try {
+        QD.callback(AD);
+      }
+      catch(std::exception& e)
+      {
+        L<<Logger::Error<<"Error in callback (while sending reply): "<<e.what()<<endl;
+      }
+      catch(...) {
+        L<<Logger::Error<<"Unknown callback (sending reply) error"<<endl;
+      }
     }
     
     delete b;
@@ -299,7 +308,16 @@ template<class Answer, class Question, class Backend>int SingleThreadDistributor
   }
   AnswerData<Answer> AD;
   AD.A=a;
-  callback(AD);
+  try {
+    callback(AD);
+  }
+  catch(std::exception& e)
+  {
+    L<<Logger::Error<<"Error in callback (while sending reply): "<<e.what()<<endl;
+  }
+  catch(...) {
+    L<<Logger::Error<<"Unknown callback (sending reply) error"<<endl;
+  }
   return 0;
 }
 
